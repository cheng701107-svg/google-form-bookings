<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>填寫預約資料</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    margin: 0;
    font-family: "Noto Sans TC", sans-serif;
    background: #f5f5f5;
  }

  .container {
    max-width: 820px;
    margin: 0 auto;
    padding: 20px;
  }

  .page-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 14px;
  }

  .card {
    background: #fff;
    border-radius: 14px;
    padding: 22px;
    border: 1px solid #e5e5e5;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    margin-bottom: 20px;
  }

  .info-row {
    margin-bottom: 10px;
    font-size: 15px;
  }

  .info-label {
    color: #666;
  }

  .info-value {
    font-weight: 700;
    color: #333;
  }

  .input-group {
    margin-bottom: 18px;
  }

  .input-label {
    font-size: 14px;
    color: #555;
    margin-bottom: 6px;
    display: block;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 16px;
    box-sizing: border-box;
    background: #fafafa;
  }

  textarea { height: 100px; resize: vertical; }

  .submit-btn {
    width: 100%;
    background: #1a73e8;
    border: none;
    padding: 16px;
    font-size: 18px;
    color: #fff;
    border-radius: 12px;
    cursor: pointer;
  }

  /* 價格明細（Airbnb 風） */
  .price-detail-box {
    margin-top: 15px;
    padding: 14px;
    border-radius: 12px;
    background: #f9fafc;
    border: 1px solid #e0e0e0;
  }
  .price-detail-item {
    font-size: 14px;
    margin-bottom: 6px;
    color: #444;
  }
  .price-detail-bold {
    font-weight: 700;
    color: #222;
  }

</style>

</head>

<body>

<div class="container">

  <div class="page-title">填寫預約資料</div>

  <!-- 訂房資訊 -->
  <div class="card" id="infoBox"></div>

  <!-- 每日價格明細 -->
  <div class="card" id="dailyBox"></div>

  <!-- 表單 -->
  <div class="card">

    <div class="input-group">
      <label class="input-label">姓名（必填）</label>
      <input type="text" id="name" required />
    </div>

    <div class="input-group">
      <label class="input-label">手機號碼（必填）</label>
      <input type="tel" id="phone" maxlength="10" placeholder="0912345678" required />
    </div>

    <div class="input-group">
      <label class="input-label">Email（選填）</label>
      <input type="email" id="email" />
    </div>

    <div class="input-group">
      <label class="input-label">大人人數</label>
      <input type="number" id="adult" value="1" min="1" />
    </div>

    <div class="input-group">
      <label class="input-label">小孩人數</label>
      <input type="number" id="child" value="0" min="0" />
    </div>

    <div class="input-group">
      <label class="input-label">是否攜帶寵物</label>
      <select id="petOption" onchange="togglePetCount()">
        <option value="no">否</option>
        <option value="yes">是</option>
      </select>
    </div>

    <div class="input-group" id="petCountBox" style="display:none;">
      <label class="input-label">寵物數量</label>
      <input type="number" id="petCount" value="1" min="1" />
    </div>

    <div class="input-group">
      <label class="input-label">備註（選填）</label>
      <textarea id="note"></textarea>
    </div>

    <input type="hidden" id="line_uid" />

    <button class="submit-btn" onclick="submitBooking()">送出預約</button>

  </div>

</div>

<script>
// ---- 取得 URL 參數 ----
const params = new URLSearchParams(location.search);
const roomId = params.get("roomId");
const checkin = params.get("date");
const checkout = params.get("checkout");
const nights = params.get("nights");
const dailyEncoded = params.get("daily");

let dailyPrices = [];
if (dailyEncoded) {
  dailyPrices = JSON.parse(decodeURIComponent(dailyEncoded));
}

let roomData = null;

// ---- 載入房型資訊 ----
async function loadInfo() {
  const res = await fetch("data/rooms.json");
  const rooms = await res.json();
  roomData = rooms.find(r => r.id === roomId);

  const total = dailyPrices.reduce((t, p) => t + p.price, 0);

  document.getElementById("infoBox").innerHTML = `
    <div class="info-row"><span class="info-label">房型：</span><span class="info-value">${roomData.title}</span></div>
    <div class="info-row"><span class="info-label">入住：</span><span class="info-value">${checkin}</span></div>
    <div class="info-row"><span class="info-label">退房：</span><span class="info-value">${checkout}</span></div>
    <div class="info-row"><span class="info-label">晚數：</span><span class="info-value">${nights} 晚</span></div>
    <div class="info-row"><span class="info-label">總金額：</span><span class="info-value">$${total.toLocaleString()}</span></div>
  `;

  // ---- 價格明細表 ----
  let html = `<div class="price-detail-box">`;

  dailyPrices.forEach(item => {
    html += `
      <div class="price-detail-item">
        ${item.date} ${item.label}：
        <span class="price-detail-bold">$${item.price.toLocaleString()}</span>
      </div>`;
  });

  html += `</div>`;

  document.getElementById("dailyBox").innerHTML = html;
}

loadInfo();

// ---- Material UI 寵物欄位 ----
function togglePetCount() {
  document.getElementById("petCountBox").style.display =
    document.getElementById("petOption").value === "yes" ? "block" : "none";
}

// ---- LINE UID ----
async function initLIFF() {
  await liff.init({ liffId: "YOUR_LIFF_ID" });
  const profile = await liff.getProfile();
  document.getElementById("line_uid").value = profile.userId;
}
initLIFF();

// ---- 送出預約 ----
function submitBooking() {

  const total = dailyPrices.reduce((t, p) => t + p.price, 0);

  const data = {
    roomId,
    checkin,
    checkout,
    nights,
    totalAmount: total,

    customer: {
      name: document.getElementById("name").value,
      phone: document.getElementById("phone").value,
      email: document.getElementById("email").value,
      adult: document.getElementById("adult").value,
      child: document.getElementById("child").value,
      pet: document.getElementById("petOption").value === "yes"
            ? document.getElementById("petCount").value
            : 0,
      note: document.getElementById("note").value,
      line_uid: document.getElementById("line_uid").value
    },

    dailyPrices // ⭐ 重點：每日價格明細送到後端
  };

  if (!data.customer.name || !data.customer.phone) {
    alert("請填寫姓名與手機！");
    return;
  }

  fetch("YOUR_API_ENDPOINT", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(() => {
    window.location.href = "done.html";
  })
  .catch(err => {
    alert("預約送出失敗！");
    console.error(err);
  });
}

</script>

</body>
</html>
