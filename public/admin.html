<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>管理後台</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  body {
    margin: 0;
    font-family: "Noto Sans TC", sans-serif;
    background: #f5f5f5;
    display: flex;
  }

  /* ---------------- Side Menu ---------------- */
  .sidebar {
    width: 220px;
    background: #1976d2;
    color: white;
    min-height: 100vh;
    padding-top: 30px;
  }

  .menu-title {
    text-align: center;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
  }

  .menu-item {
    padding: 16px 20px;
    cursor: pointer;
    font-size: 17px;
  }

  .menu-item:hover {
    background: #145ea8;
  }

  .menu-item.active {
    background: #1565c0;
  }

  /* ---------------- Main Content ---------------- */
  .content {
    flex: 1;
    padding: 20px;
  }

  h2 {
    margin-top: 0;
  }

  /* Search Bar */
  .search-box {
    background: white;
    padding: 10px 16px;
    border-radius: 12px;
    display: flex;
    gap: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }

  .search-box input {
    border: none;
    outline: none;
    flex: 1;
    font-size: 16px;
  }

  /* Table */
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  th, td {
    padding: 14px;
    border-bottom: 1px solid #eee;
    font-size: 15px;
  }

  th {
    background: #f0f0f0;
    text-align: left;
  }

  .tag {
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
  }

  .tag-unpaid { background: #ffebee; color: #c62828; }
  .tag-deposit { background: #fff3cd; color: #c58900; }
  .tag-paid { background: #e8f5e9; color: #2e7d32; }

  .tag-active { background: #e3f2fd; color: #1976d2; }
  .tag-cancelled { background: #ffebee; color: #c62828; }
  .tag-checkedin { background: #ede7f6; color: #5e35b1; }
  .tag-completed { background: #e8f5e9; color: #2e7d32; }

  .btn-icon {
    cursor: pointer;
    color: #1976d2;
  }

  /* ---------------- Modal ---------------- */
  .modal-bg {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    display: none;
    justify-content: center;
    align-items: center;
  }

  .modal {
    width: 92%;
    max-width: 550px;
    background: white;
    border-radius: 14px;
    padding: 22px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  .form-row {
    margin-bottom: 14px;
  }

  .form-row label {
    display: block;
    font-size: 14px;
    color: #555;
    margin-bottom: 6px;
  }

  .form-row input,
  .form-row select,
  .form-row textarea {
    width: 100%;
    padding: 10px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  .modal-btns {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 18px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    font-weight: 600;
  }

  .btn-cancel { background: #eee; }
  .btn-save { background: #1976d2; color: white; }

</style>
</head>

<body>

<!-- ---------------- Sidebar ---------------- -->
<div class="sidebar">
  <div class="menu-title">管理後台</div>

  <div class="menu-item active">訂單管理</div>

  <div class="menu-item" onclick="location.href='admin-rooms.html'">
    房型管理
  </div>

  <div class="menu-item">系統設定（未來可擴充）</div>
</div>

<!-- ---------------- Main Content ---------------- -->
<div class="content">

  <h2>訂單管理</h2>

  <div class="search-box">
    <span class="material-icons">search</span>
    <input id="searchInput" placeholder="搜尋姓名 / 電話 / 房型..." oninput="renderTable()" />
  </div>

  <table>
    <thead>
      <tr>
        <th>姓名</th>
        <th>房型</th>
        <th>入住</th>
        <th>退房</th>
        <th>金額</th>
        <th>付款</th>
        <th>狀態</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="orderTable"></tbody>
  </table>

</div>

<!-- ---------------- Edit Modal ---------------- -->
<div class="modal-bg" id="modalBg">
  <div class="modal" id="modal">

    <h3>編輯訂單</h3>

    <div class="form-row">
      <label>姓名</label>
      <input id="m_name" />
    </div>

    <div class="form-row">
      <label>手機</label>
      <input id="m_phone" />
    </div>

    <div class="form-row">
      <label>Email</label>
      <input id="m_email" />
    </div>

    <div class="form-row">
      <label>付款方式</label>
      <select id="m_paymentMethod">
        <option value="none">未選擇</option>
        <option value="bank">匯款</option>
        <option value="linepay">LINE Pay</option>
        <option value="card">信用卡</option>
      </select>
    </div>

    <div class="form-row">
      <label>匯款後五碼</label>
      <input id="m_paymentCode" />
    </div>

    <div class="form-row">
      <label>付款狀態</label>
      <select id="m_paymentStatus">
        <option value="unpaid">未付款</option>
        <option value="deposit">已付訂</option>
        <option value="paid">已付全額</option>
      </select>
    </div>

    <div class="form-row">
      <label>訂單狀態</label>
      <select id="m_status">
        <option value="active">成立</option>
        <option value="checkedin">已入住</option>
        <option value="completed">已完成</option>
        <option value="cancelled">已取消</option>
      </select>
    </div>

    <div class="form-row">
      <label>備註（MARK）</label>
      <textarea id="m_mark"></textarea>
    </div>

    <div class="form-row">
      <label>業者備註</label>
      <textarea id="m_note"></textarea>
    </div>

    <div class="modal-btns">
      <button class="btn btn-cancel" onclick="closeModal()">取消</button>
      <button class="btn btn-save" onclick="saveOrder()">儲存</button>
    </div>

  </div>
</div>

<script type="module">

/* ----------------------------------------------------
    Firebase 初始化
---------------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCnytMF9E5kgjadIe8EpKYoWCqsAVR93I0",
  authDomain: "form-booking-8fb46.firebaseapp.com",
  projectId: "form-booking-8fb46",
  storageBucket: "form-booking-8fb46.appspot.com",
  messagingSenderId: "866268132852",
  appId: "1:866268132852:web:566f1fe2d79cacabd6b5a1",
  measurementId: "G-J1RNH6VBTG"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ----------------------------------------------------
    全域變數
---------------------------------------------------- */
let orders = [];
let editingId = null;

/* ----------------------------------------------------
    標籤顏色
---------------------------------------------------- */
function payTag(code) {
  return {
    unpaid: `<span class="tag tag-unpaid">未付款</span>`,
    deposit: `<span class="tag tag-deposit">已付訂</span>`,
    paid: `<span class="tag tag-paid">已付全額</span>`
  }[code];
}

function statusTag(code) {
  return {
    active: `<span class="tag tag-active">成立</span>`,
    cancelled: `<span class="tag tag-cancelled">取消</span>`,
    checkedin: `<span class="tag tag-checkedin">已入住</span>`,
    completed: `<span class="tag tag-completed">完成</span>`
  }[code];
}

/* ----------------------------------------------------
    讀取訂單
---------------------------------------------------- */
async function loadOrders() {
  const snap = await getDocs(collection(db, "orders"));

  orders = [];
  snap.forEach(d => orders.push({ id: d.id, ...d.data() }));

  renderTable();
}

loadOrders();

/* ----------------------------------------------------
    搜尋 + 渲染
---------------------------------------------------- */
window.renderTable = function () {
  const keyword = document.getElementById("searchInput").value.trim();

  const tbody = document.getElementById("orderTable");
  tbody.innerHTML = "";

  orders
    .filter(o =>
      o.name.includes(keyword) ||
      o.phone.includes(keyword) ||
      o.roomTitle.includes(keyword)
    )
    .forEach(o => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${o.name}</td>
        <td>${o.roomTitle}</td>
        <td>${o.checkIn}</td>
        <td>${o.checkOut}</td>
        <td>$${o.priceTotal.toLocaleString()}</td>
        <td>${payTag(o.paymentStatus)}</td>
        <td>${statusTag(o.status)}</td>
        <td>
          <span class="material-icons btn-icon" onclick="editOrder('${o.id}')">edit</span>
          <span class="material-icons btn-icon" onclick="deleteOrder('${o.id}')">delete</span>
        </td>
      `;

      tbody.appendChild(tr);
    });
};

/* ----------------------------------------------------
    編輯訂單（填入 Modal）
---------------------------------------------------- */
window.editOrder = function (id) {
  editingId = id;
  const o = orders.find(x => x.id === id);

  document.getElementById("m_name").value = o.name;
  document.getElementById("m_phone").value = o.phone;
  document.getElementById("m_email").value = o.email ?? "";

  document.getElementById("m_paymentMethod").value = o.paymentMethod;
  document.getElementById("m_paymentCode").value = o.paymentCode ?? "";
  document.getElementById("m_paymentStatus").value = o.paymentStatus;

  document.getElementById("m_status").value = o.status;

  document.getElementById("m_mark").value = o.mark ?? "";
  document.getElementById("m_note").value = o.note ?? "";

  document.getElementById("modalBg").style.display = "flex";
};

/* ----------------------------------------------------
    儲存訂單
---------------------------------------------------- */
window.saveOrder = async function () {
  const ref = doc(db, "orders", editingId);

  await updateDoc(ref, {
    name: document.getElementById("m_name").value,
    phone: document.getElementById("m_phone").value,
    email: document.getElementById("m_email").value,

    paymentMethod: document.getElementById("m_paymentMethod").value,
    paymentCode: document.getElementById("m_paymentCode").value,
    paymentStatus: document.getElementById("m_paymentStatus").value,

    status: document.getElementById("m_status").value,
    mark: document.getElementById("m_mark").value,
    note: document.getElementById("m_note").value
  });

  closeModal();
  loadOrders();
};

/* ----------------------------------------------------
    刪除訂單
---------------------------------------------------- */
window.deleteOrder = async function (id) {
  if (!confirm("要刪除此訂單？")) return;

  await deleteDoc(doc(db, "orders", id));
  loadOrders();
};

/* ----------------------------------------------------
    關閉 Modal
---------------------------------------------------- */
window.closeModal = function () {
  document.getElementById("modalBg").style.display = "none";
};

</script>

</body>
</html>
