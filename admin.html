<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>管理後台</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="style.css">
<script src="api.js"></script>

</head>

<body>

<div class="header">預約後台管理</div>

<div class="container">

  <!-- 搜尋列 -->
  <div class="card">
    <div class="card-title">搜尋訂單</div>

    <div class="field-group">
      <label>姓名</label>
      <input type="text" id="searchName" placeholder="輸入姓名">
    </div>

    <div class="field-group">
      <label>電話</label>
      <input type="text" id="searchPhone" placeholder="輸入手機">
    </div>

    <div class="field-group">
      <label>入住日期</label>
      <input type="date" id="searchDate">
    </div>

    <button class="btn" onclick="loadBookings()">搜尋</button>
  </div>

  <!-- 訂單列表 -->
  <div class="card">
    <div class="card-title">訂單列表</div>

    <table class="table" id="bookingTable">
      <thead>
        <tr>
          <th>訂單編號</th>
          <th>姓名</th>
          <th>電話</th>
          <th>房型</th>
          <th>入住</th>
          <th>退房</th>
          <th>金額</th>
          <th>狀態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="9" style="text-align:center;">載入中...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- 浮動新增按鈕（可對業主販售升級功能） -->
<div class="fab" onclick="alert('預留：新增訂單功能可作為付費升級項目！')">
  ＋
</div>

<script src="api.js"></script>

<script>
// 載入訂單
async function loadBookings() {
  const name  = document.getElementById("searchName").value;
  const phone = document.getElementById("searchPhone").value;
  const date  = document.getElementById("searchDate").value;

  const roomData = await apiGet("?action=rooms");
  const rooms = roomData.rooms;
  const roomMap = {};
  rooms.forEach(r => roomMap[r.room_id] = r.name);

  const bookingData = await apiGet("?action=bookings");
  let bookings = bookingData.bookings;

  if (name)  bookings = bookings.filter(b => b.name.includes(name));
  if (phone) bookings = bookings.filter(b => b.phone.includes(phone));
  if (date)  bookings = bookings.filter(b => b.checkin === date);

  renderBookings(bookings, roomMap);
}

// 渲染 Table
function renderBookings(list, roomMap) {
  const tbody = document.querySelector("#bookingTable tbody");
  tbody.innerHTML = "";

  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">沒有資料</td></tr>`;
    return;
  }

  list.forEach(b => {
    tbody.innerHTML += `
      <tr>
        <td>${b.order_id}</td>
        <td>${b.name}</td>
        <td>${b.phone}</td>
        <td>${roomMap[b.room_id] || "-"}</td>
        <td>${b.checkin}</td>
        <td>${b.checkout}</td>
        <td>NT$ ${b.amount}</td>
        <td>${b.status}</td>
        <td>
          <button onclick="updateStatus('${b.order_id}', 'confirmed')">確認</button>
          <button onclick="updateStatus('${b.order_id}', 'cancelled')">取消</button>
          <button onclick="deleteBooking('${b.order_id}')">刪除</button>
        </td>
      </tr>
    `;
  });
}

async function updateStatus(orderId, status) {
  const res = await apiPost("?action=updateBooking", { order_id: orderId, status });

  if (res.success) {
    alert("已更新！");
    loadBookings();
  } else alert("更新失敗：" + res.message);
}

async function deleteBooking(orderId) {
  if (!confirm("確定要刪除？")) return;

  const res = await apiPost("?action=deleteBooking", { order_id: orderId });

  if (res.success) {
    alert("已刪除！");
    loadBookings();
  } else alert("刪除失敗：" + res.message);
}

// 預設載入
loadBookings();
</script>


</body>
</html>
